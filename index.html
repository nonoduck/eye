<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çœ¼ç›èª¿ç¯€äº’å‹•æ¨¡æ“¬å™¨ - è¿‘è¦–æˆåƒå„ªåŒ–ç‰ˆ</title>
    <style>
        * { box-sizing: border-box; }
        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif;
            background: #f0f2f5; overflow: hidden;
        }
        
        .app-container {
            display: flex; flex-direction: column;
            width: 100vw; height: 100vh; padding: 15px;
        }

        .header { text-align: center; margin-bottom: 10px; }
        .header h2 { margin: 5px 0; color: #1a202c; }

        .vision-selector { 
            display: flex; justify-content: center; gap: 10px; margin-bottom: 15px;
        }
        .mode-btn { 
            padding: 10px 24px; border: 2px solid #cbd5e0; border-radius: 30px; 
            cursor: pointer; transition: all 0.2s; background: white; font-weight: bold; color: #4a5568;
        }
        .mode-btn.active { background: #4a90e2; color: white; border-color: #4a90e2; box-shadow: 0 4px 12px rgba(74,144,226,0.3); }

        #canvas-wrapper { 
            flex: 1; position: relative; background: white; border-radius: 24px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05);
            display: flex; justify-content: center; align-items: center;
            overflow: hidden; border: 1px solid #e2e8f0;
        }

        svg { width: 100%; height: 100%; touch-action: none; }

        .footer-info { padding: 15px; text-align: center; }
        .status-box { 
            background: #fff; padding: 15px 30px; border-radius: 50px; 
            display: inline-block; min-width: 450px; box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            border: 1px solid #edf2f7;
        }
        
        #instruction { color: #718096; font-size: 0.9rem; margin-top: 10px; }
    </style>
</head>
<body>

<div class="app-container">
    <div class="header">
        <h2>çœ¼ç›èª¿ç¯€ï¼šå…‰å­¸æˆåƒæ¨¡æ“¬</h2>
    </div>

    <div class="vision-selector">
        <div class="mode-btn active" onclick="setMode('normal', this)">è¦–åŠ›æ­£å¸¸</div>
        <div class="mode-btn" onclick="setMode('myopia', this)">è¿‘è¦– (çœ¼è»¸éé•·)</div>
        <div class="mode-btn" onclick="setMode('presbyopia', this)">è€èŠ± (èª¿ç¯€åŠ›å¼±)</div>
    </div>

    <div id="canvas-wrapper">
        <svg viewBox="0 0 800 400" id="eyeSvg" preserveAspectRatio="xMidYMid meet">
            <defs>
                <filter id="retinaBlur">
                    <feGaussianBlur in="SourceGraphic" stdDeviation="0" id="blurFilter" />
                </filter>
                <linearGradient id="rayGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                    <stop offset="0%" stop-color="rgba(255, 222, 89, 0.1)" />
                    <stop offset="50%" stop-color="rgba(255, 222, 89, 0.4)" />
                    <stop offset="100%" stop-color="rgba(255, 222, 89, 0.1)" />
                </linearGradient>
            </defs>

            <path id="retina" d="M 650 100 A 120 150 0 0 1 650 300" fill="none" stroke="#f56565" stroke-width="6" stroke-linecap="round" />
            <text x="660" y="90" fill="#f56565" font-size="14" font-weight="bold">è¦–ç¶²è†œ</text>

            <path id="light-rays" d="" fill="url(#rayGradient)" stroke="rgba(255, 215, 0, 0.5)" stroke-width="1" />

            <ellipse id="lens" cx="450" cy="200" rx="15" ry="50" fill="rgba(173, 216, 230, 0.8)" stroke="#4a90e2" stroke-width="2" />
            
            <g id="retina-image" filter="url(#retinaBlur)">
                <g transform="translate(650, 200) scale(0.6, -0.6)">
                    <rect x="-20" y="-25" width="40" height="50" fill="#fff" stroke="#333" stroke-width="2" />
                    <rect x="-15" y="-10" width="30" height="3" fill="#e2e8f0" />
                    <rect x="-15" y="0" width="30" height="3" fill="#e2e8f0" />
                    <text x="-12" y="15" font-size="12" fill="#2d3748" font-weight="bold">ğŸ“–</text>
                </g>
            </g>

            <g id="book" style="cursor: grab;">
                <rect x="0" y="0" width="50" height="65" rx="4" fill="#fff" stroke="#2d3748" stroke-width="3" />
                <rect x="10" y="15" width="30" height="4" fill="#cbd5e0" />
                <rect x="10" y="25" width="30" height="4" fill="#cbd5e0" />
                <text x="8" y="52" font-size="11" font-weight="bold" fill="#2d3748">BOOK</text>
            </g>
        </svg>
    </div>

    <div class="footer-info">
        <div class="status-box">
            <div id="status-desc">æº–å‚™å°±ç·’</div>
        </div>
        <div id="instruction">ğŸ’¡ é»æ“Šæ›¸æœ¬å·¦å³æ‹–å‹•ã€‚è¿‘è¦–æ™‚ï¼Œæ›¸æœ¬é è¿‘æœƒä½¿è¦–ç¶²è†œä¸Šçš„æˆåƒè®Šæ¸…æ™°ã€‚</div>
    </div>
</div>

<script>
    const svg = document.getElementById('eyeSvg');
    const book = document.getElementById('book');
    const lens = document.getElementById('lens');
    const rays = document.getElementById('light-rays');
    const statusDesc = document.getElementById('status-desc');
    const blurFilter = document.getElementById('blurFilter');
    
    let currentMode = 'normal';
    let isDragging = false;
    let bookX = 150;

    function setMode(mode, btn) {
        currentMode = mode;
        document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        updateVisuals(bookX);
    }

    function updateVisuals(x) {
        book.setAttribute('transform', `translate(${x}, 167.5)`);

        const lensX = 450;
        const retinaX = 650;
        const distance = lensX - x; 
        const distFactor = Math.max(0, (400 - distance) / 350); 

        // 1. æ°´æ™¶é«”å½¢ç‹€æ§åˆ¶
        let rx = 12;
        let ry = 50;
        if (currentMode === 'presbyopia') {
            rx = 12 + (distFactor * 6); // è€èŠ±ï¼šè®Šåšèƒ½åŠ›æ¥µé™å¾ˆä½
        } else {
            rx = 12 + (distFactor * 25); // æ­£å¸¸èˆ‡è¿‘è¦–ï¼šèª¿ç¯€åŠ›å¥½
            ry = 50 - (distFactor * 5);
        }
        lens.setAttribute('rx', rx);
        lens.setAttribute('ry', ry);

        // 2. ç„¦é»é‚è¼¯ (é—œéµä¿®æ”¹)
        let focusX = 650; 

        if (currentMode === 'myopia') {
            // è¿‘è¦–ï¼šç‰©é«”åœ¨é æ–¹æ™‚ç„¦é»åœ¨è¦–ç¶²è†œå‰ (ä¾‹å¦‚ 580)
            // ç•¶ç‰©é«”é è¿‘ (distance è®Šå°)ï¼Œç„¦é»æœƒå‘å¾Œç§»å‹•
            // æ¨¡æ“¬ï¼šç•¶ distance æ¥è¿‘ 100 æ™‚ï¼Œç„¦é»å›åˆ° 650
            const myopiaOffset = 70; // é è™•æ™‚åé›¢è¦–ç¶²è†œçš„è·é›¢
            focusX = (650 - myopiaOffset) + (distFactor * (myopiaOffset + 10));
        } else if (currentMode === 'presbyopia') {
            // è€èŠ±ï¼šé è™•æ­£å¸¸ï¼Œè¿‘è™•æ™‚æ°´æ™¶é«”ä¸å¤ åšï¼Œç„¦é»è½åœ¨å¾Œæ–¹
            if (distance < 250) {
                focusX = 650 + ((250 - distance) * 0.5);
            }
        } else {
            // æ­£å¸¸ï¼šè‡ªå‹•èª¿ç¯€ï¼Œå§‹çµ‚ä¿æŒåœ¨è¦–ç¶²è†œ
            focusX = 650;
        }

        // 3. æ›´æ–°å…‰ç·š (è€ƒæ…®ç„¦é»)
        const lensTop = 200 - ry;
        const lensBottom = 200 + ry;
        const bookRight = x + 50;
        const pathData = `M ${bookRight} 185 L 450 ${lensTop} L ${focusX} 200 L 450 ${lensBottom} L ${bookRight} 215 Z`;
        rays.setAttribute('d', pathData);

        // 4. è¦–ç¶²è†œæˆåƒæ¨¡ç³Šåº¦
        const blurAmount = Math.abs(focusX - retinaX) / 4;
        blurFilter.setAttribute('stdDeviation', blurAmount);

        // 5. æ›´æ–°ç‹€æ…‹æ–‡å­—
        let statusText = "";
        if (blurAmount < 1.2) {
            statusText = "<span style='color: #2f855a;'>âœ… <b>å½±åƒæ¸…æ™°</b>ï¼šå…‰ç·šæº–ç¢ºèšç„¦æ–¼è¦–ç¶²è†œã€‚</span>";
        } else {
            const pos = focusX < retinaX ? "å‰æ–¹" : "å¾Œæ–¹";
            statusText = `<span style='color: #c05621;'>âš ï¸ <b>å½±åƒæ¨¡ç³Š</b>ï¼šç„¦é»è½åœ¨è¦–ç¶²è†œ${pos}ã€‚</span>`;
        }
        statusDesc.innerHTML = statusText;
    }

    // äº’å‹•æ§åˆ¶
    function getEventX(e) {
        const CTM = svg.getScreenCTM();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        return (clientX - CTM.e) / CTM.a;
    }

    function startDrag(e) { isDragging = true; }
    function endDrag() { isDragging = false; }
    function moveDrag(e) {
        if (!isDragging) return;
        let x = getEventX(e) - 25;
        if (x < 20) x = 20;
        if (x > 380) x = 380;
        bookX = x;
        updateVisuals(bookX);
    }

    book.addEventListener('mousedown', startDrag);
    window.addEventListener('mousemove', moveDrag);
    window.addEventListener('mouseup', endDrag);
    book.addEventListener('touchstart', startDrag);
    window.addEventListener('touchmove', moveDrag);
    window.addEventListener('touchend', endDrag);

    // åˆå§‹å‘¼å«
    updateVisuals(bookX);
</script>

</body>
</html>
